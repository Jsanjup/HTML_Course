<html>

<head>
    <title>Caja registradora</title> 
    <link href='css/styles.css' rel="stylesheet"/>;
    <style type="text/css">
     p {
         color: rgb(17, 7, 153); 
         font-family: Verdana;
     }
    </style>

</head>

<body>
    <h1>CAJA REGISTRADORA</h1>

    <h2>Productos</h2>
    <table id="vitrina"></table>
    <br>
    <p>
        ------------------------------------
    </p>
    <br>
    <h2>Tu Carro</h2>
    <table id="carrito"></table>
    <form name="carro">
        <h4>Producto</h4>
        <select name="productos" id="productos">
            <option value="zanahorias">Zanahorias</option>
            <option value="patatas">Patatas</option>
            <option value="manzanas">Manzanas</option>
            <option value="lechugas">Lechugas</option>
            <option value="naranjas">Naranjas</option>
        </select>
        <h4>Cantidad</h4>
        <input type="number" name="cantidad" value="0" size="2">
        <input type="button" name="" value="Lo quiero" onclick="addToCart()">

    </form>
    <br>
    <br>
    <br>
    <br>
    <br>
    <p>
        ------------------------------------
    </p>
    <br>
    <form name="calc">
        <h3>Total a Pagar</h3>
        <input type="number" name="total" value="0" size="4" disabled>
        <br>
        <h3>Pago</h3>
        <input type="number" name="pagado" value="0" size="4">
        <input type="button" name="" value="Pagar" onclick="paga()">
        <br>
        <h3> Cambio</h3>
        <input type="text" name="cambio" value="0" size="4" disabled>
        <br>
        <br>

    </form>

    <script type="text/javascript">
        const productos = {
            "zanahorias": { precio: 2, stock: 20 },
            "patatas": { precio: 1, stock: 120 },
            "manzanas": { precio: 3, stock: 40, descuento:20 },
            "lechugas": { precio: 4, stock: 5 },
            "naranjas": { precio: 5, stock: 15, descuento: 15},
        };
        let carrito = {};// si carrito es una constante no puede volver a cero para la siguiente compra, por eso ponermos let

        function addToCart() {
            let seleccionado = document.carro.producto.value;
            let cantidad = parseInt(document.carro.cantidad.value);//parseInt convierte los strings en números-, parsear es recorrer un string y ocnvertirlo en algo
            let estado = productos[seleccionado];
            // variable "estado" que acababamos de establecer es unir el producto seleccionado al estado del producto, es decir al precio y al stock
            //le ponemos un stop para que verifique el stock
            if (estado.stock >= cantidad) {
                estado.stock = estado.stock - cantidad;
                let total = parseInt(document.calc.total.value);
                let preciodescuento = descuento(estado.precio, cantidad, estado.descuento); // con esto le paso la cantidad original, el precio original y el del descuento
                total += preciodescuento ; 
                // precio solo no funciona, pq es una variable que no existe. En cambio! la variable estado existe y tiene un campo que es el precio 
                // si pongo += es como concatenar strings; si a un string le sumo número detrás lo único que hace es concatenárselos, parseInt( ) para que ya no sea un string -> transforma un string en número
                document.calc.total.value = total;
                //modificamos el carrito antes de que lo pinte porque si no no veríamos los cambios realizados
                if (carrito[seleccionado]) { // esto es : si existe la variable carrito seleccionado que haga tal.. (lo que está entre {})
                    let previo = carrito[seleccionado];
                    carrito[seleccionado] = { precio: previo.precio + preciodescuento, stock: previo.stock + cantidad };
                } else {
                    carrito[seleccionado] = { precio: preciodescuento, stock: cantidad };
                    // puedo poner para precio parseInt(document.calc.total.value) o cantidad*estado.precio <- esta funciona mejor, porque la otra suma a lo ya sumado
                    //Hemos recopiado las funcionas rellenaVitrina y carritoActual para evocarlas porque sino no se modifican
                
                }
                rellenaVitrina();
                carritoActual();
            }
            else {
                alert(`Solo quedan ${estado.stock} ${seleccionado}`)

            }
        }

        function paga() {
            let total = parseInt(document.calc.total.value); // hay que añadir parseInt porque si no, lo que hace es comparar strings alfabéticamente
            let pagado = parseInt(document.calc.pagado.value);
            if (pagado < total) {
                alert(`falta dinero`)
            } else {
                document.calc.cambio.value = pagado - total;
                carrito = {}; // para que el carrito se ponga a cero para la próxima compra
                carritoActual(); // pongo carrito actual para que se vea el carrito actual vaciado
            }
        }

        function rellenaVitrina() {
            let htmlTable = "<tr><th>Producto</th><th>Stock</th><th>Precio</th></tr>";
            for (let p of Object.keys(productos)) {
                htmlTable += `<tr><td>${p}</td><td>${productos[p].stock}</td><td>${productos[p].precio}</td></tr>`;
            }
            let vitrina = document.getElementById("vitrina");
            vitrina.innerHTML = htmlTable;
        }

        function carritoActual() {
            let htmlTable = "";
            if (Object.keys(carrito).length > 0) {
                htmlTable = "<tr><th>Producto</th><th>Cantidad</th><th>Precio</th></tr>";
                for (let p of Object.keys(carrito)) {
                    htmlTable += `<tr><td>${p}</td><td>${carrito[p].stock}</td><td>${carrito[p].precio}</td></tr>`;
                }
            }
            let vistaCarrito = document.getElementById("carrito");
            vistaCarrito.innerHTML = htmlTable;
        }
        function descuento(precio, cantidad, descuento) {
            let preciofinal
            if (descuento){
                preciofinal = precio*cantidad*(1-(descuento/100))
            } else {
                preciofinal = precio*cantidad
            }
            return preciofinal;
        }

        rellenaVitrina();
        carritoActual();
    </script>
</body>

</html>