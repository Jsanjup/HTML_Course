<html>

<head>
    <title>Caja registradora</title>
</head>

<body>
    <h1>CAJA REGISTRADORA</h1>


    <h2>Productos</h2>
    <table id="vitrina"></table>
    <br>
    <p>
        ------------------------------------
    </p>
    <br>
    <h2>Tu Carro</h2>
    <table id="carrito"></table>
    <form name="carro">
        <h4>Producto</h4>
        <select name="productos" id="productos">
            <option value="zanahorias">Zanahorias</option>
            <option value="patatas">Patatas</option>
            <option value="manzanas">Manzanas</option>
            <option value="lechugas">Lechugas</option>
            <option value="naranjas">Naranjas</option>
        </select>
        <h4>Cantidad</h4>
        <input type="number" name="cantidad" value="0" size="2">
        <input type="button" name="" value="Lo quiero" onclick="addToCart()">

    </form>
    <br>
    <br>
    <br>
    <br>
    <br>
    <p>
        ------------------------------------
    </p>
    <br>
    <form name="calc">
        <h3>Total a Pagar</h3>
        <input type="number" name="total" value="0" size="4" disabled>
        <br>
        <h3>Pago</h3>
        <input type="number" name="pagado" value="0" size="4">
        <input type="button" name="" value="Pagar" onclick="paga()">
        <br>
        <h3> Cambio</h3>
        <input type="text" name="cambio" value="0" size="4" disabled>
        <br>
        <br>

    </form>

    <script type="text/javascript">
        const productos = {
            "zanahorias": { precio: 2, stock: 20 },
            "patatas": { precio: 1, stock: 120 },
            "manzanas": { precio: 3, stock: 40 },
            "lechugas": { precio: 4, stock: 5 },
            "naranjas": { precio: 5, stock: 15 },
        };

        const carrito = {};

        function addToCart() {
            let seleccionado = document.carro.productos.value; // me lo está tratando como string y no como número. 
            // creo una variable seleccionado, que está en document y productos, value. Hago lo mismo con cantidad. 
            let cantidad = parseInt(document.carro.cantidad.value); //parsea : recorrer un string y convertirlo en cosas, en este caso en números. 
            let estado = productos[seleccionado] // se crea una variable nueva a la que se le asigna un valor, el del seleccionado. 

            if (estado.stock >= cantidad) {

                // para que se le añada al carrito. debemos reducir el stock
                estado.stock = estado.stock - cantidad;
                let total = parseInt(document.calc.total.value);
                total += cantidad * estado.precio; //precio no es una variable que exista, pero sí recono estado.precio poeq está justo antes definida. sabe lo que es estado, y este tiene una variable que es precio. 
                document.calc.total.value = total;// tenemos que poner parseint para convertir esto document.calc.total.value a número. (ahora mismo es un string) += (guarda y suma con lo siguiente) no funciona. 
                if (carrito[seleccionado]) { //si existe la variable 
                    let previous = carrito[seleccionado];
                    carrito[seleccionado] = { precio: previous.precio + cantidad * estado.precio, stock: previo.stock + cantidad };
                }
                else {
                    carrito[seleccionado] = { precio: cantidad * estado.precio, stock: cantidad };
                }


                rellenaVitrina(); //hemos invocado las funciones porq sino no se afecta el jS
                carritoActual();
            } else {
                alert(`solo quedan ${estado.stock} ${seleccionado}`)
            }
        }

        function paga() {
            let total = parseInt(document.calc.total.value); //sin parseint me lo compara por orden alfabético. No me lo reconoce como un número. Por eso ponemos parseint. Parseint es una función. 
            let pagado = parseInt(document.calc.total.value);
            if (pagado < total) {
                alert("falta dinero")
            }
            else {
                document.calc.cambio.value = pagado - total;
                carrito = {};
                carritoActual(); //para que se bea el carrito vacío. 

            }
        }

        function rellenaVitrina() {
            let htmlTable = "<tr><th>Producto</th><th>Stock</th><th>Precio</th></tr>";
            for (let p of Object.keys(productos)) {
                htmlTable += `< tr ><td>${p}</td><td>${productos[p].stock}</td><td>${productos[p].precio}</td></tr > `;
            }
            let vitrina = document.getElementById("vitrina");
            vitrina.innerHTML = htmlTable;
        }

        function carritoActual() {
            let  htmlTable = "";
            if (Object.keys(carrito).length > 0) { //condición, el número de claves (campos) es más que 0.
                htmlTable = "<tr><th>Producto</th><th>Cantidad</th><th>Precio</th></tr>";
                for (let p of Object.keys(carrito)) {
                    htmlTable += `< tr ><td>${p}</td><td>${carrito[p].stock}</td><td>${carrito[p].precio}</td></tr >`;
                }
            }
            let vistaCarrito = document.getElementById("carrito");
            vistaCarrito.innerHTML = htmlTable;
        }

        rellenaVitrina();
        carritoActual();
    </script>
</body>

</html>